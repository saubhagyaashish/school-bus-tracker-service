// Prisma Schema for School Bus Tracker

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==================== AUTH ====================

enum Role {
  SUPER_ADMIN
  SCHOOL_ADMIN
  DRIVER
  PARENT
}

// Unified User model for authentication
model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String
  name         String
  phone        String?
  role         Role
  schoolId     Int? // null for SUPER_ADMIN
  isActive     Boolean  @default(true)
  isApproved   Boolean  @default(true) // false for self-registered parents
  isFirstLogin Boolean  @default(true) // force password change
  fcmToken     String? // push notifications
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  school   School?   @relation(fields: [schoolId], references: [id])
  students Student[] // for PARENT role
  buses    Bus[] // for DRIVER role (assigned buses)

  @@index([role])
  @@index([schoolId])
}

// Refresh tokens for session management
model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

// ==================== SCHOOL ====================

model School {
  id        Int      @id @default(autoincrement())
  name      String
  address   String?
  phone     String?
  code      String   @unique // for parent registration
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users    User[]
  buses    Bus[]
  routes   Route[]
  students Student[]
}

// ==================== BUS & ROUTES ====================

model Bus {
  id              Int      @id @default(autoincrement())
  name            String
  licensePlate    String?
  traccarDeviceId Int?
  traccarUniqueId String?
  capacity        Int?
  schoolId        Int
  driverId        Int? // assigned driver (User with DRIVER role)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  school   School    @relation(fields: [schoolId], references: [id])
  driver   User?     @relation(fields: [driverId], references: [id])
  routes   Route[]
  students Student[]

  @@unique([traccarDeviceId])
  @@unique([traccarUniqueId])
  @@index([schoolId])
}

model Route {
  id          Int       @id @default(autoincrement())
  name        String
  description String?
  type        RouteType @default(MORNING)
  schoolId    Int
  busId       Int?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  school School @relation(fields: [schoolId], references: [id])
  bus    Bus?   @relation(fields: [busId], references: [id])
  stops  Stop[]

  @@index([schoolId])
}

enum RouteType {
  MORNING
  AFTERNOON
  BOTH
}

model Stop {
  id          Int      @id @default(autoincrement())
  name        String
  latitude    Float
  longitude   Float
  address     String?
  routeId     Int
  stopOrder   Int
  avgWaitTime Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  route    Route     @relation(fields: [routeId], references: [id], onDelete: Cascade)
  students Student[]

  @@unique([routeId, stopOrder])
}

// ==================== STUDENT ====================

model Student {
  id        Int      @id @default(autoincrement())
  name      String
  grade     String?
  rollNo    String?
  schoolId  Int
  parentId  Int // User with PARENT role
  busId     Int?
  stopId    Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school School @relation(fields: [schoolId], references: [id])
  parent User   @relation(fields: [parentId], references: [id])
  bus    Bus?   @relation(fields: [busId], references: [id])
  stop   Stop?  @relation(fields: [stopId], references: [id])

  @@index([parentId])
  @@index([schoolId])
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int // changed from parentId
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([userId])
}

enum NotificationType {
  BUS_ARRIVING
  BUS_DEPARTED
  BUS_DELAYED
  CHILD_BOARDED
  CHILD_DROPPED
  GENERAL
}

// ==================== ATTENDANCE ====================

model Attendance {
  id        Int              @id @default(autoincrement())
  studentId Int
  busId     Int
  date      DateTime         @db.Date
  boardedAt DateTime?
  droppedAt DateTime?
  status    AttendanceStatus @default(PENDING)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@unique([studentId, busId, date])
  @@index([date])
}

enum AttendanceStatus {
  PENDING
  BOARDED
  DROPPED
  ABSENT
}
